#include <stdio.h>
#include <string.h> // for string - strcpy
#include <unistd.h> // for sleep()

// conditional compilation block — it’s used to include specific code only when your program is compiled on Windows.
// Since we include void clearScreen and we are using windows
#ifdef _WIN32
#include <windows.h>
#endif

#define P printf
#define S scanf
#define t typeText
#define BOLD    "\033[1m"
#define RED     "\033[0;31m"
#define GREEN   "\033[0;32m"
#define YELLOW  "\033[0;33m"
#define BLUE    "\033[0;34m"
#define MAGENTA "\033[0;35m"
#define CYAN    "\033[0;36m"
#define PINK    "\033[1;35m"
#define RESET   "\033[0m"



// Fast, no-lag screen clear function
void clearScreen() {
#ifdef _WIN32
	HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
	DWORD dwMode = 0;
	GetConsoleMode(hOut, &dwMode);
	dwMode |= 0x0004; // ENABLE_VIRTUAL_TERMINAL_PROCESSING
	SetConsoleMode(hOut, dwMode);
#endif
	P("\033[2J\033[H"); // ANSI escape code to clear screen instantly
	fflush(stdout);
}


// Typing animation
void typeText(const char *text, int delay_ms) {
	for (int i = 0; text[i] != '\0'; i++) {
		printf("%c", text[i]);
		fflush(stdout);
#ifdef _WIN32
		Sleep(delay_ms);
#else
		usleep(delay_ms * 1000);
#endif
	}
}

// Loading dots animation
void loadingDots(int count, int delay_ms) {
	for (int i = 0; i < count; i++) {
		printf(".");
		fflush(stdout);
#ifdef _WIN32
		Sleep(delay_ms);
#else
		usleep(delay_ms * 1000);
#endif
	}
}

// Main program
int main() {
	int running = 1; // will put this in while loop so the code will keep on
	int Your_choice;

	while(running == 1) {
		t(CYAN"================================================\n"RESET, 10);
		t(PINK"  PILLPAL: Smart Medicine Reminder and Guide"RESET, 50);
		t(CYAN"\n================================================\n\n"RESET, 10);
		P("Choose One\n");
		P("1. Create Custom Medicine Schedule\n");
		P("2. Lola Victorina's Maintenance\n");
		P("3. Exit\n");
		P(YELLOW"Enter your choice (1-3): "RESET);
		S("%d", &Your_choice);
		clearScreen();


		switch (Your_choice) {
		case 1:
			char medicine_name[10][50]; // array for medicine name
			int interval[10]; // to store up to 10 interval time since in medicine name is also 10
			int time_taken[10]; // same with interval
			int num_medicines = 0;
			char more_med;
			int num_days;

			t(CYAN"\n=====================================================\n"RESET,10);
			t(BOLD"                       CUSTOM"RESET, 50);
			t(CYAN"\n=====================================================\n"RESET, 10);

			// Input medicine names and intervals
			do {
				P(YELLOW"\nEnter the Medicine name: "RESET);
				S("%s", medicine_name[num_medicines]);


                // Prompt the user for the medicine intake hour and repeat until a valid value (0–23) is entered
				do {
					P(YELLOW"Time of intake for %s (0-23): "RESET, medicine_name[num_medicines]);
					S("%d", &time_taken[num_medicines]);
					if(time_taken[num_medicines] < 0 || time_taken[num_medicines] > 23) {
						P(RED"\nInvalid hour! Please enter a time between 0 and 23.\n\n"RESET);
					}
				} while(time_taken[num_medicines] < 0 || time_taken[num_medicines] > 23);

                // Prompt the user for the medicine interval hour and repeat until a valid value (1–24) is entered
				do {
					P(YELLOW"How many hours apart should you take the medicine? (in hours: 1-24): "RESET);
					S("%d", &interval[num_medicines]);
					if(interval[num_medicines] < 1 || interval[num_medicines] > 24) {
						P(RED"\nInvalid hour! Please enter a time between 1 and 24.\n\n"RESET);
					}
				} while(interval[num_medicines] < 1 || interval[num_medicines] > 24);
				num_medicines++;

				// Checking the maximum numbers of medicine input
				if (num_medicines >= 10) {
					P(RED"You have reached the max number of medicines.\n"RESET);
					break;
				}

				P(YELLOW"\nNeed to input another medicine? (y/n): "RESET);
				S(" %c", &more_med);

			} while (more_med == 'y' || more_med == 'Y');

			P(YELLOW"\nEnter number of days: "RESET);
			S("%d", &num_days);
			clearScreen();

			int Day = 1;
			do {
				P(CYAN"\n======================\n"RESET);
				P("      DAY %d ", Day);
				P(CYAN"\n======================\n\n"RESET);

				// Track how many times each medicines was taken that day
				int s_count[10] = {0};

				for (int h = 0; h < 24; h++) {
					// int Hour = (h + time_taken) % 24;
					P(" %d:00 ~ ", h);

					int medicineTaken = 0;
					int firstMed = 1; // for "&" formatting
					for (int i = 0; i < num_medicines; i++) {
						if (h >= time_taken[i] && ((h - time_taken[i]) % interval[i] == 0)) {
							if (!medicineTaken) {
								P(RED "Take " RESET);
								medicineTaken = 1;
							}
                            
                            // Print "&" between medicine names, but only after the first one in the same hour
							if (!firstMed) P(" & ");
							P(BLUE"%s"RESET, medicine_name[i]);

							s_count[i]++;
							firstMed = 0;

						}
					}

					if (!medicineTaken) {
						P("No medicine taken");
					}
					P("\n") ;
				}


				// Daily summary
				P(GREEN"\n~~~~~~~~~~~ Summary for Day %d ~~~~~~~~~~ \n"RESET, Day);
				for(int i = 0; i < num_medicines; i++) {
					P("%s taken: %d time(s): \n", medicine_name[i], s_count[i]);
				}
				P(GREEN"~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n"RESET);

				Day++;
			} while (Day <= num_days);
			break;


		case 2:
			// ==========LOLA VICTORINA'S MAINTENANCE=========
			P(CYAN"\n--- PATIENT INFORMATION ---\n"RESET);
			t("Name: Victorina\n", 50);
			t("Age: 78 yrs old\n", 50);
			t("Sex: Female\n", 50);
			P(CYAN"------------------------------\n"RESET);
			P("Diagnoses and Prescriptions:\n");
			P("1. Hypertension:\n");
			P("   - Losartan (50 mg) -> 2:00 PM\n");
			P("   - Amlodipine (5 mg) -> 2:00 PM\n");
			P("2. Type 2 Diabetes Mellitus:\n");
			P("   - Metformin (500 mg) -> 12:00 PM / 7:00 PM\n");
			P("   - Glimepiride (2 mg)-> 6:00 AM\n");
			P("3. Hyperlipidemia:\n");
			P("   - Atorvastatin (20 mg) -> 9:00 PM\n");
			P("4. Multivitamins:\n");
			P("   - Multivitamins -> 6:00 AM\n");
			P(CYAN"------------------------------\n"RESET);

			// MODE
			int choice;
			P("\nIs this reminder for?\n");
			P("1. Specific number of days\n");
			P("2. Lifetime\n");

			// Userinput
			P(YELLOW"Enter your choice: "RESET);
			S("%d", &choice);


			int days;
			if(choice == 1) {
				P(YELLOW"Enter number of days: "RESET);
				S("%d", &days);
			} else {
				days = 1; // Will simulate one day only (For lifetime)
			}


			int day = 1;
			do {
				P(CYAN"\n============================================\n"RESET);
				if(choice == 1) {
					P("           DAY %d - Victorina\n", day);
				} else {
					P("   LIFETIME DAILY REMINDER - Victorina\n");
				}
				P(CYAN"============================================\n\n"RESET);

				// Define these medicine as integer to store numbers taken for displaying summary of these medicine taken.
				int glimepiride = 0, multivitamins = 0, metformin = 0,
				    losartan = 0, amlodipine = 0, atorvastatin = 0;

				int hour;
				// for loop to print 24 hours format
				for(int hour = 0; hour < 24; hour++) {
					int P_hour = (hour == 0 || hour == 24) ? 12 : hour % 12; // we use ternary operator
					char time_period[3]; //String for "AM" and "PM"
					strcpy(time_period, (hour < 12) ? "AM" : "PM");
					P("%2d:00 %s - ", P_hour, time_period); // Priting the time. (e.g 12:00 PM)

					/*
					Glimepiride- 6:00 AM
					Multivitamins- 6:00 AM
					Metformin- 12:00 PM
					Losartan- 2:00 PM
					Amlodipine- 2:00 PM
					Metformin- 7:00 PM
					Atorvastatin- 9:00 PM
					*/



					if(hour == 6) {
						P(RED"It's time to take your Glimepiride & Multivitamins!\n"RESET);
						glimepiride++;
						multivitamins++;
					} else if(hour == 12) {
						P(RED"It's time to take your Metformin!\n"RESET);
						metformin++;
					} else if(hour == 14) {
						P(RED"It's time to take your Losartan and Amlodipine!\n"RESET);
						losartan++;
						amlodipine++;
					} else if(hour == 19) {
						P(RED"It's time to take your Metformin Again!\n"RESET);
						metformin++;
					} else if(hour == 21) {
						P(RED"It's time to take your Atorvastatin!\n"RESET);
						atorvastatin++;
					}
					else {
						P("No dose scheduled\n");
					}
				}

				// summary of medicines taken
				P(GREEN"\n-- Summary for Day %d --\n"RESET, day);
				P("Losartan taken: %d time(s)\n", losartan);
				P("Amlodipine taken: %d time(s)\n", amlodipine);
				P("Metformin taken: %d time(s)\n", metformin);
				P("Glimepiride taken: %d time(s)\n", glimepiride);
				P("Atorvastatin taken: %d time(s)\n", atorvastatin);
				P("Multivitamins taken: %d time(s)\n", multivitamins);

				day++;
			} while (day <= days);

			if(choice == 2) {
				P(RED"\nThis is a lifetime reminder. Lola Victorina should follow this schedule daily.\n"RESET); //lifetime remider
			}
			P("\n");
			break;

		case 3:
			P(GREEN "\nThank you for using PILLPAL! Stay healthy \n" RESET);
			P(PINK"\nMEMBERS:\n"RESET);
			char members[5][50] = {
				"Baniega, Lance Runel D.",
				"Padilla, John Rolly Q.",
				"Pineda, Allen Regz A.",
				"Ricalde, Vin Archie A.",
				"Rondina, Leona Gabrielle M."
			};

			for(int n = 0; n < 5; n++) {
				P("%s\n", members[n]);
			};


			t(CYAN "\nClosing in 3..." RESET, 50);
			sleep(1);
			t(" 2...", 10);
			sleep(1);
			t(" 1...\n", 10);
			sleep(1);
			clearScreen();
			running = 0;
			break;

		default:
			P(RED"\nIncorrect input. Please try again\n"RESET);
		}
		P("\n");
	}
	return 0;
}
